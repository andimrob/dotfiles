#!/usr/bin/env bash

_run_rubocop() {
  echo "Running rubocop pre-commit hook"

  git rev-parse -q --verify MERGE_HEAD && echo "Merge commit... skipping rubocop checks." && exit 0

  FILES=$(git diff --cached --name-only --diff-filter=ACM)

  echo "Changed files:"
  echo "$FILES"

  FINAL_CODE=0

  _check_and_run_rubocop() {
    local dir="$1"
    local changed_files

    if [[ "$dir" == "." ]]; then
      changed_files=$(echo "$FILES" | grep '\.rb$' | grep -v '/')
    else
      changed_files=$(echo "$FILES" | grep "^${dir}/" | grep '\.rb$' | sed "s|^${dir}/||")
    fi

    [[ -z "$changed_files" ]] && return

    echo "Running rubocop against $dir"
    echo "Changed files: $changed_files"

    pushd "$dir" > /dev/null || return
    # shellcheck disable=SC2086
    if ! bundle exec rubocop $changed_files; then
      FINAL_CODE=1
      # shellcheck disable=SC2086
      bundle exec rubocop -a $changed_files
    fi
    popd > /dev/null || return
  }

  # Check root directory
  if [[ -f "Gemfile" ]] && [[ -f ".rubocop.yml" ]]; then
    _check_and_run_rubocop "."
  fi

  # Check direct child directories (skip symlinks)
  for dir in */; do
    dir="${dir%/}"
    [[ -L "$dir" ]] && continue
    if [[ -f "$dir/Gemfile" ]] && [[ -f "$dir/.rubocop.yml" ]]; then
      _check_and_run_rubocop "$dir"
    fi
  done

  if [[ $FINAL_CODE -ne 0 ]]; then
    echo "Rubocop updated files. Resubmit your commit."
    exit $FINAL_CODE
  fi

  echo "Rubocopping complete..."
}

_run_rubocop
