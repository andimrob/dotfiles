# -----------------------------------------------------------------------------
# Key Bindings
# -----------------------------------------------------------------------------

# Change prefix to Ctrl-a (easier to reach than Ctrl-b)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Reload config
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# Split panes with | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind L select-pane -R

# Switch to last active window (like cd -)
bind l last-window

# Resize panes with Ctrl + hjkl
bind -r C-h resize-pane -L 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-l resize-pane -R 5

# Window navigation
bind -r n next-window
bind -r p previous-window

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Kill pane/window without confirmation
bind x kill-pane
bind X kill-window

# -----------------------------------------------------------------------------
# Behavior
# -----------------------------------------------------------------------------

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase history limit
set -g history-limit 50000

# Reduce escape time (faster vim response)
set -sg escape-time 0

# Enable focus events
set -g focus-events on

# Don't rename windows automatically
set -g allow-rename off

# Vi mode for copy
setw -g mode-keys vi

# Copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"

# -----------------------------------------------------------------------------
# Appearance
# -----------------------------------------------------------------------------

# True color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",*:Tc"

# Status bar position
set -g status-position bottom
set -g status-interval 1

# Status bar base styling
set -g status-style "bg=colour236,fg=colour253"
set -g status-left-length 60
set -g status-right-length 120

# Powerline symbols:  (U+E0B0)  (U+E0B1)  (U+E0B2)  (U+E0B3)

# Left: prefix indicator + session name
# Shows yellow when prefix is pressed, green otherwise
set -g status-left "#{?client_prefix,#[fg=colour232]#[bg=colour220]#[bold]  #S #[fg=colour220]#[bg=colour236],#[fg=colour232]#[bg=colour107]#[bold]  #S #[fg=colour107]#[bg=colour236]} "

# Right: hostname + date + time
set -g status-right "#[fg=colour239]#[fg=colour253,bg=colour239]  #h #[fg=colour107]#[fg=colour232,bg=colour107]  %d %b #[fg=colour220]#[fg=colour232,bg=colour220,bold]  %H:%M "

# Window status (inactive) - off-white bg with grey text, orange for last active
set -g window-status-format "#{?window_last_flag,#[fg=colour236 bg=colour208] #I #{pane_current_command} #{s|.*/([^/]+/[^/]+)$|\\1|:pane_current_path} #[fg=colour208 bg=colour236],#[fg=colour236 bg=colour251] #I #{pane_current_command} #{s|.*/([^/]+/[^/]+)$|\\1|:pane_current_path} #[fg=colour251 bg=colour236]}"

# Window status (active/current)
set -g window-status-current-format "#[fg=colour236,bg=colour75]#[fg=colour231,bg=colour75]*#[fg=colour236]#I #{pane_current_command} #{s|.*/([^/]+/[^/]+)$|\\1|:pane_current_path} #[fg=colour75,bg=colour236]"

set -g window-status-separator " "

# Pane borders
set -g pane-border-style "fg=colour239"
set -g pane-active-border-style "fg=colour107"

# Pane number display
set -g display-panes-active-colour colour107
set -g display-panes-colour colour220

# Message styling
set -g message-style "bg=colour220,fg=colour232,bold"

# Mode styling (copy mode, etc.)
setw -g mode-style "bg=colour220,fg=colour232"

# Clock mode
set -g clock-mode-colour colour107
set -g clock-mode-style 24

# -----------------------------------------------------------------------------
# FZF Integration
# -----------------------------------------------------------------------------

# Switch session
bind s display-popup -E -w 60% -h 60% "\
    tmux list-sessions -F '#{session_name}' | \
    fzf --reverse --header='Switch Session' | \
    xargs -I{} tmux switch-client -t {}"

# Switch window (across all sessions)
bind w display-popup -E -w 60% -h 60% "\
    tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' | \
    fzf --reverse --header='Switch Window' | \
    cut -d' ' -f1 | \
    xargs -I{} tmux switch-client -t {}"

# Kill session
bind K display-popup -E -w 60% -h 60% "\
    tmux list-sessions -F '#{session_name}' | \
    fzf --reverse --multi --header='Kill Session(s)' | \
    xargs -I{} tmux kill-session -t {}"

# -----------------------------------------------------------------------------
# Mouse Menus
# -----------------------------------------------------------------------------

# Click on left status (session name) = quick popups menu
bind -n MouseDown1StatusLeft display-menu -x M -y S \
    "btop" b "run-shell 'tmux display-popup -E -w 80% -h 80% btop'" \
    "lazygit" g "run-shell 'tmux display-popup -E -w 80% -h 80% -d #{pane_current_path} lazygit'" \
    "" \
    "Sync Panes #{?pane_synchronized,OFF,ON}" s "setw synchronize-panes"

# Popup shortcuts
bind b display-popup -E -w 80% -h 80% "btop"
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "lazygit"

# Click on right status (time area) = actions menu
bind -n MouseDown1StatusRight display-menu -x R -y S \
    "Sessions" s "choose-tree -Zs" \
    "Windows" w "choose-tree -Zw" \
    "" \
    "New Window" n "new-window -c '#{pane_current_path}'" \
    "New Session" S "new-session" \
    "" \
    "#{?window_zoomed_flag,Unzoom,Zoom} Pane" z "resize-pane -Z" \
    "Horizontal Split" h "split-window -v -c '#{pane_current_path}'" \
    "Vertical Split" v "split-window -h -c '#{pane_current_path}'" \
    "" \
    "Reload Config" r "source-file ~/.config/tmux/tmux.conf; display 'Config reloaded'" \
    "Kill Pane" x "kill-pane" \
    "Kill Window" X "kill-window"
