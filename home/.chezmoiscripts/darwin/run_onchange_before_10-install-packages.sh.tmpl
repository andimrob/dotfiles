#!/usr/bin/env bash
set -euo pipefail

# Hash of mise config to trigger re-run when tools change
# mise.toml hash: {{ include "dot_config/mise/config.toml" | sha256sum }}

# Variables
readonly MISE_INSTALL_URL="https://mise.run"

# Logging function
log() {
    echo "[macos-deps] $*"
}

# Install Homebrew and essential packages
install_homebrew() {
    log "Checking Homebrew installation..."

    # Check if Homebrew is installed
    if ! command -v brew &>/dev/null; then
        log "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for current session
        if [[ -f /opt/homebrew/bin/brew ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [[ -f /usr/local/bin/brew ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi
    else
        log "Homebrew already installed"
    fi

    # Ensure essential packages are installed
    log "Checking essential packages..."
    local packages=("curl" "git" "gnupg")
    for pkg in "${packages[@]}"; do
        if ! brew list "$pkg" &>/dev/null; then
            log "Installing $pkg via Homebrew..."
            brew install "$pkg"
        fi
    done
}

# Install Brewfile packages
install_brewfile() {
    local brewfile="{{ .chezmoi.homeDir }}/.Brewfile"

    if [[ -f "$brewfile" ]]; then
        log "Installing packages from Brewfile..."
        brew bundle --file="$brewfile" --no-lock
    else
        log "No Brewfile found, skipping..."
    fi
}

# Install mise if not already available
install_mise() {
    if command -v mise &>/dev/null; then
        log "mise already installed ($(mise --version))"
        return 0
    fi

    log "Installing mise..."
    if ! curl -fsSL "$MISE_INSTALL_URL" | sh; then
        log "Error: Failed to install mise"
        exit 1
    fi

    # Add mise to PATH for current session
    export PATH="$HOME/.local/bin:$PATH"

    if ! command -v mise &>/dev/null; then
        log "Error: mise command not found after installation"
        exit 1
    fi

    log "mise installed successfully ($(mise --version))"
}

# Install all mise-managed tools (idempotent)
install_mise_tools() {
    log "Installing mise-managed tools..."

    # Ensure mise shims are available
    eval "$(mise activate bash)"

    # mise install is idempotent - skips already installed tools
    if ! mise install; then
        log "Error: Failed to install mise tools"
        exit 1
    fi

    log "All mise tools installed successfully"
}

# Main logic
main() {
    log "Setting up macOS dependencies..."

    # Install Homebrew and essential packages
    install_homebrew

    # Install Brewfile packages
    install_brewfile

    # Install mise if needed (idempotent)
    install_mise

    # Install all tools from mise config (idempotent)
    install_mise_tools

    log "All macOS dependencies ready"
}

# Run main function
main "$@"
