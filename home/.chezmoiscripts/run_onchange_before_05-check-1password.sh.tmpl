#!/usr/bin/env bash
set -euo pipefail

# Variables
readonly OP_ACCOUNT="${OP_ACCOUNT:-family}"

# Logging function
log() {
    echo "[1password] $*"
}

# Check if already signed in to 1Password
is_signed_in() {
    # Activate mise to ensure op is in PATH
    eval "$(mise activate bash)" 2>/dev/null || true

    if command -v op &>/dev/null && op whoami &>/dev/null 2>&1; then
        return 0
    fi
    return 1
}

# Check 1Password accessibility (informative, non-blocking)
check_1password() {
    if ! command -v op &>/dev/null; then
        log "Warning: op command not found. 1Password templates will fail."
        return 1
    fi

    # Check for desktop app integration (socket exists and connected)
{{ if eq .chezmoi.os "darwin" -}}
    local op_socket="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{ else if eq .chezmoi.os "linux" -}}
    local op_socket="$HOME/.1password/agent.sock"
{{ else -}}
    local op_socket=""
{{ end -}}

    if [[ -n "$op_socket" ]] && [[ -S "$op_socket" ]]; then
        log "1Password desktop app integration detected"
        return 0
    fi

    # Check if authenticated via CLI session
    if is_signed_in; then
        log "1Password CLI session active"
        log "Note: Session tokens may not persist to chezmoi subprocess"
        log "Consider enabling desktop app CLI integration for seamless auth"
        return 0
    fi

    # Not authenticated - warn but don't block
    log "Warning: 1Password not authenticated"
    log ""
    log "Templates using 1Password will fail. To authenticate:"
    log ""
    log "GUI environments (persistent):"
    log "  1. Open 1Password desktop app"
    log "  2. Go to Settings > Developer"
    log "  3. Enable 'Connect with 1Password CLI'"
    log ""
    log "Headless environments (session-based):"
    log "  1. Run: eval \$(op signin)"
    log "  2. Then: chezmoi apply"
    log ""
    log "Continuing anyway..."
    return 1
}

# Main logic
main() {
    check_1password || true
}

# Run main function
main "$@"
